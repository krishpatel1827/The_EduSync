{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<style>
    /* Reset & Base */
    .timetable-body {
        font-family: 'Arial Narrow', Arial, sans-serif;
        background-color: var(--clr-bg);
        padding: 5px;
        color: var(--clr-text);
        max-width: 100%;
        overflow-x: auto;
        transition: background-color 0.4s ease, color 0.4s ease;
    }

    /* Controls (Hide in print) */
    .controls {
        margin-bottom: 10px;
        display: flex;
        gap: 5px;
        justify-content: center;
        flex-wrap: wrap;
        background: var(--clr-surface-alt);
        padding: 10px;
        border-bottom: 1px solid var(--clr-border);
    }

    .controls .btn {
        padding: 5px 15px;
        color: white;
        text-decoration: none;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: bold;
    }

    .controls .btn-dark {
        background-color: var(--clr-text);
        color: var(--clr-bg);
    }

    .controls .btn-primary {
        background-color: var(--clr-accent);
    }

    .controls .btn-secondary {
        background-color: var(--clr-text-muted);
    }

    .controls .btn-success {
        background-color: var(--clr-success, #28a745);
    }

    .controls .btn-danger {
        background-color: #dc3545;
    }

    @media print {
        .controls {
            display: none;
        }

        .timetable-body {
            padding: 0;
            overflow: visible;
        }

        @page {
            size: landscape;
            margin: 0.5cm;
        }
    }

    /* Header */
    .header-section {
        text-align: center;
        border: 2px solid var(--clr-text);
        border-bottom: none;
        padding: 5px;
        position: relative;
        background-color: var(--clr-surface);
    }

    .header-section h1 {
        font-size: 20px;
        font-weight: 900;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--clr-text);
    }

    .header-section h2 {
        font-size: 16px;
        font-weight: 800;
        margin: 5px 0;
        text-transform: uppercase;
        background-color: var(--clr-surface);
        color: var(--clr-text);
    }

    .header-section h3 {
        font-size: 14px;
        font-weight: 700;
        margin: 2px 0;
        text-transform: uppercase;
        text-decoration: underline;
        color: var(--clr-text);
    }

    /* Main Table */
    .tt-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid var(--clr-text);
        font-size: 11px;
        text-align: center;
        table-layout: fixed;
    }

    .tt-table th,
    .tt-table td {
        border: 1px solid var(--clr-border);
        padding: 4px 2px;
        vertical-align: middle;
        word-wrap: break-word;
        transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
    }

    /* Column Widths */
    .col-day {
        width: 3%;
    }

    .col-lec {
        width: 3%;
    }

    .col-time {
        width: 8%;
    }

    /* Header Styling */
    .header-row-1 th {
        background-color: var(--clr-surface);
    }

    .header-row-2 th {
        background-color: #ffdcb2;
        /* D1, D2 color (Peach) */
    }

    .header-row-3 th {
        background-color: #e6ffff;
        /* Sub/Fac/Room color (Light Cyan) */
        font-size: 9px;
    }

    /* Vertical Text */
    .vertical-text-cell {
        font-weight: bold;
        vertical-align: middle;
        text-align: center;
        width: 30px;
        letter-spacing: 10px;
        /* Force width */
        padding: 0 !important;
    }

    .vertical-text-wrapper {
        writing-mode: vertical-rl;
        /* Standard vertical text Top-to-Bottom, Right-to-Left lines */
        transform: rotate(180deg);
        /* Flip to read Bottom-to-Top */
        white-space: nowrap;
        display: inline-block;
        max-height: 100%;
    }

    /* Data Colors */
    .row-normal td {
        background-color: var(--clr-surface);
    }

    /* Specific Logic for Time/Room Column background */
    .cell-time {
        background-color: #ccffcc;
        /* Light Green */
        font-weight: bold;
        font-size: 10px;
    }

    .cell-content {
        font-size: 10px;
    }

    .text-subject {
        font-weight: bold;
        color: var(--clr-text);
    }

    .text-faculty {
        font-weight: normal;
        color: var(--clr-text-muted);
        font-style: normal;
    }

    .text-room {
        font-weight: bold;
        font-size: 9px;
    }

    /* Break Row */
    .break-row td {
        background-color: var(--clr-surface);
        font-weight: bold;
        text-align: center;
        padding: 5px;
        border-top: 2px solid var(--clr-text);
        border-bottom: 2px solid var(--clr-text);
    }

    /* Footer */
    .footer-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid var(--clr-text);
        border-top: none;
        font-size: 11px;
        color: var(--clr-text);
    }

    .footer-heading {
        background-color: #dbadbd;
        font-weight: bold;
        text-align: center;
        border: 1px solid var(--clr-border);
        padding: 5px;
    }

    .footer-sub-heading {
        background-color: var(--clr-surface-alt);
        font-weight: bold;
        text-align: center;
        border: 1px solid var(--clr-border);
        padding: 3px;
    }

    .footer-content {
        border: 1px solid var(--clr-border);
        vertical-align: top;
        padding: 0;
        background-color: var(--clr-surface);
    }

    .signature-section {
        background-color: var(--clr-surface-alt);
        border: 1px solid var(--clr-border);
        text-align: center;
        padding: 20px;
        font-weight: bold;
        width: 50%;
    }

    .prepared-by {
        background-color: var(--clr-surface-alt);
    }

    ul.legend {
        list-style: none;
        padding: 5px 10px;
        margin: 0;
        text-align: center;
    }

    ul.legend li {
        margin-bottom: 2px;
    }

    /* THEME: CLASSIC (Default) */
    .theme-classic .header-row-2 th {
        background-color: #ffdcb2;
    }

    /* Peach */
    .theme-classic .header-row-3 th {
        background-color: #e6ffff;
    }

    /* Cyan */
    .theme-classic .cell-time {
        background-color: #ccffcc;
    }

    /* Green */
    .theme-classic .footer-heading {
        background-color: #dbadbd;
    }

    /* Pink */
    .theme-classic .footer-sub-heading {
        background-color: #e6e6e6;
    }

    /* Grey */
    .theme-classic .text-subject {
        color: var(--clr-text);
    }

    /* THEME: MODERN BLUE */
    .theme-modern_blue .header-row-2 th {
        background-color: #bbdefb;
        color: black;
    }

    .theme-modern_blue .header-row-3 th {
        background-color: #e3f2fd;
        color: black;
    }

    .theme-modern_blue .cell-time {
        background-color: #e8eaf6;
        color: black;
    }

    .theme-modern_blue .footer-heading {
        background-color: #2196f3;
        color: white;
    }

    .theme-modern_blue .footer-sub-heading {
        background-color: #90caf9;
    }

    .theme-modern_blue .row-normal td {
        border-color: #90caf9;
    }

    /* THEME: NATURE GREEN */
    .theme-nature_green .header-row-2 th {
        background-color: #c8e6c9;
    }

    .theme-nature_green .header-row-3 th {
        background-color: #e8f5e9;
    }

    .theme-nature_green .cell-time {
        background-color: #f1f8e9;
    }

    .theme-nature_green .footer-heading {
        background-color: #4caf50;
        color: white;
    }

    .theme-nature_green .footer-sub-heading {
        background-color: #a5d6a7;
    }

    /* THEME: SUNSET ORANGE */
    .theme-sunset_orange .header-row-2 th {
        background-color: #ffccbc;
    }

    .theme-sunset_orange .header-row-3 th {
        background-color: #fbe9e7;
    }

    .theme-sunset_orange .cell-time {
        background-color: #fff3e0;
    }

    .theme-sunset_orange .footer-heading {
        background-color: #ff5722;
        color: white;
    }

    .theme-sunset_orange .footer-sub-heading {
        background-color: #ffab91;
    }

    /* THEME: MINIMAL DARK */
    .theme-minimal_dark .timetable-body {
        background-color: #121212;
        color: #e0e0e0;
    }

    .theme-minimal_dark table {
        border-color: #333;
    }

    .theme-minimal_dark th,
    .theme-minimal_dark td {
        border-color: #333;
        background-color: #1e1e1e;
        color: #e0e0e0;
    }

    .theme-minimal_dark .header-row-2 th {
        background-color: #333;
        color: white;
    }

    .theme-minimal_dark .header-row-3 th {
        background-color: #424242;
        color: white;
    }

    .theme-minimal_dark .cell-time {
        background-color: #2c2c2c;
    }

    .theme-minimal_dark .footer-heading {
        background-color: #333;
        color: white;
    }

    .theme-minimal_dark .footer-sub-heading {
        background-color: #424242;
        color: #e0e0e0;
    }

    .theme-minimal_dark .text-subject {
        color: #81d4fa;
    }

    .theme-minimal_dark .text-faculty {
        color: #b0bec5;
    }

    .theme-minimal_dark .header-section h1,
    .theme-minimal_dark .header-section h2,
    .theme-minimal_dark .header-section h3 {
        color: #e0e0e0;
        background-color: #121212;
    }

    /* Default (Classic) Colors for items that were inline */
    .division-header {
        background-color: #ffe0cc;
        font-size: 14px;
    }

    .theme-modern_blue .division-header {
        background-color: #64b5f6;
        color: white;
    }

    .theme-nature_green .division-header {
        background-color: #81c784;
    }

    .theme-sunset_orange .division-header {
        background-color: #ff8a65;
    }

    .theme-minimal_dark .division-header {
        background-color: #424242;
        color: white;
    }

    .cell-data {
        background-color: #e6f7ff;
    }

    .theme-modern_blue .cell-data {
        background-color: #e1f5fe;
    }

    .theme-nature_green .cell-data {
        background-color: #f1f8e9;
    }

    .theme-sunset_orange .cell-data {
        background-color: #fbe9e7;
    }

    .theme-minimal_dark .cell-data {
        background-color: #1e1e1e;
        color: #e0e0e0;
        border-color: #333;
    }
</style>

<div class="timetable-body theme-{{ current_timetable.theme_palette }}">
    <!-- Controls -->
    <div class="controls">
        <a href="{% url 'generator' %}" class="btn btn-dark">&larr; Dashboard</a>

        <form action="{% url 'toggle_theme' current_timetable.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-info text-white">üé® Change Theme</button>
        </form>

        <a href="{% url 'add_entry' %}" class="btn btn-primary">+ Add Entry</a>
        {% if current_timetable %}
        {% if current_timetable.is_published %}
        <form action="{% url 'publish_timetable' current_timetable.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">‚úì Published (Click to Unpublish)</button>
        </form>
        {% else %}
        <button type="button" class="btn btn-warning"
            onclick="document.getElementById('publishPanel').style.display = document.getElementById('publishPanel').style.display === 'none' ? 'block' : 'none'">
            üìå Publish to Students
        </button>
        {% endif %}
        {% endif %}
        <a href="{% url 'setup' %}" class="btn btn-secondary">Configure</a>
        {% if current_timetable %}
        <form action="{% url 'auto_generate_timetable' current_timetable.id %}" method="post" style="display:inline;"
            onsubmit="return confirm('Are you sure? This will overwrite existing entries.')">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning">Auto Generate</button>
        </form>
        <form action="{% url 'clear_timetable' current_timetable.id %}" method="post" style="display:inline;"
            onsubmit="return confirm('Are you sure you want to clear ALL entries? This cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Clear All</button>
        </form>
        <a href="{% url 'export_excel' current_timetable.id %}" class="btn btn-success">Excel</a>
        <a href="{% url 'export_pdf' current_timetable.id %}" class="btn btn-danger">PDF</a>
        {% endif %}
    </div>

    <!-- Publish Confirmation Panel -->
    {% if current_timetable and not current_timetable.is_published %}
    <div id="publishPanel" style="display: none; padding: 24px; background: var(--clr-surface); border: 1px solid var(--clr-border); border-radius: var(--radius); margin-bottom: 10px; box-shadow: var(--shadow-md);">
        <h5 style="margin: 0 0 6px 0; color: var(--clr-text); font-weight: 700; font-size: 1.1rem;">Publish Timetable</h5>
        <p style="color: var(--clr-text-muted); font-size: 0.9rem; margin-bottom: 20px;">Confirm the department, branch, and name before publishing to students.</p>
        <form action="{% url 'publish_timetable' current_timetable.id %}" method="post">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                {% for field in publish_form %}
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--clr-text); font-size: 0.85rem;">{{ field.label }}</label>
                    {{ field }}
                </div>
                {% endfor %}
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button type="submit" style="padding: 8px 20px; background: var(--clr-success, #28a745); color: white; border: none; border-radius: var(--radius-sm); font-weight: 700; cursor: pointer; font-size: 0.9rem;">
                    Confirm & Publish
                </button>
                <button type="button" style="padding: 8px 20px; background: var(--clr-surface-alt); color: var(--clr-text); border: 1px solid var(--clr-border); border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; font-size: 0.9rem;"
                    onclick="document.getElementById('publishPanel').style.display = 'none'">
                    Cancel
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Title Header -->
    <div class="header-section position-relative">
        <h1 class="text-uppercase">{{ current_timetable.heading_1 }}</h1>
        <h2 class="text-uppercase">{{ current_timetable.heading_2 }}</h2>
        <h3 class="text-uppercase">{{ current_timetable.name }}</h3>

        <!-- Edit Button (Hidden in Print) -->
        <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 m-2 d-print-none"
            onclick="document.getElementById('editHeaderForm').style.display = document.getElementById('editHeaderForm').style.display === 'none' ? 'block' : 'none'"
            title="Edit Headers">
            ‚úèÔ∏è
        </button>
    </div>

    <!-- Edit Header Inline Form -->
    <div id="editHeaderForm" style="display: none; padding: 20px; background: var(--clr-surface); border: 1px solid var(--clr-border); border-top: none; border-radius: 0 0 var(--radius) var(--radius);">
        <h5 style="margin-bottom: 15px; color: var(--clr-text); font-weight: 700;">Edit Timetable Headers</h5>
        <form action="{% url 'edit_timetable_header' current_timetable.id %}" method="post">
            {% csrf_token %}
            {% for field in header_form %}
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 600; margin-bottom: 4px; color: var(--clr-text); font-size: 0.9rem;">{{ field.label }}</label>
                {{ field }}
            </div>
            {% endfor %}
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('editHeaderForm').style.display = 'none'">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Timetable Grid -->
    <table class="tt-table">
        <thead>
            <!-- Row 1: Main Headers -->
            <tr class="header-row-1">
                <th rowspan="3" class="col-day">DAY</th>
                <th rowspan="3" class="col-lec">LECTURE NO</th>
                <th rowspan="3" class="col-time">
                    <div>TIME/</div>
                    <div>ROOM NO.</div>
                </th>
                <!-- Division Header Spanning All Divisions -->
                <th colspan="{{ divisions|length|multiply:3 }}" class="division-header">
                    DIVISION</th>
                <th rowspan="3" class="col-day">DAY</th>
            </tr>
            <!-- Row 2: Division Names -->
            <tr class="header-row-2">
                {% for div in divisions %}
                <th colspan="3">{{ div.name }}</th>
                {% endfor %}
            </tr>
            <!-- Row 3: Sub/Fac/Room -->
            <tr class="header-row-3">
                {% for div in divisions %}
                <th>Subject</th>
                <th>Faculty</th>
                <th>Room No</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for day in timetable_data %}
            {% with day.slots as slots %}
            {% for slot_data in slots %}
            {% if slot_data.slot.is_break %}
            <tr class="break-row">
                <!-- Day Left -->
                {% if forloop.first %}
                <td rowspan="{{ slots|length }}" class="vertical-text-cell" style="background-color: var(--clr-surface-alt);">
                    <div class="vertical-text-wrapper">{{ day.day_code }}</div>
                </td>
                {% endif %}

                <!-- Break Content -->
                <td colspan="{{ divisions|length|multiply:3|add:2 }}">
                    BREAK ({{ slot_data.slot.start_time|date:"g:i am" }} to {{ slot_data.slot.end_time|date:"g:i am" }})
                </td>

                <!-- Day Right -->
                {% if forloop.first %}
                <td rowspan="{{ slots|length }}" class="vertical-text-cell" style="background-color: var(--clr-surface-alt);">
                    <div class="vertical-text-wrapper">{{ day.day_code }}</div>
                </td>
                {% endif %}
            </tr>
            {% else %}
            <tr class="row-normal">
                <!-- Day Column (First slot only) -->
                {% if forloop.first %}
                <td rowspan="{{ slots|length }}" class="vertical-text-cell" style="background-color: var(--clr-surface-alt);">
                    <div class="vertical-text-wrapper">{{ day.day_code }}</div>
                </td>
                {% endif %}

                <!-- Lecture No -->
                <td style="font-weight: bold;" class="cell-data">{{ slot_data.slot.lecture_number }}</td>

                <!-- Time -->
                <td class="cell-time">
                    {{ slot_data.slot.start_time|date:"g:ia" }} to <br>
                    {{ slot_data.slot.end_time|date:"g:ia" }}
                </td>

                <!-- Division Data -->
                {% for div in divisions %}
                {% with slot_data.entries|get_item:div.id as entry %}
                {% if entry %}
                <td class="cell-content text-subject cell-data">{{ entry.subject.code }}</td>
                <td class="cell-content text-faculty cell-data">{{ entry.faculty.initials }}
                </td>
                <td class="cell-content text-room cell-data">{{ entry.room.number }}</td>
                {% else %}
                <!-- Empty Cells -->
                <td class="cell-data">-</td>
                <td class="cell-data">-</td>
                <td class="cell-data">-</td>
                {% endif %}
                {% endwith %}
                {% endfor %}

                <!-- Right Day Column -->
                {% if forloop.first %}
                <td rowspan="{{ slots|length }}" class="vertical-text-cell" style="background-color: var(--clr-surface-alt);">
                    <div class="vertical-text-wrapper">{{ day.day_code }}</div>
                </td>
                {% endif %}
            </tr>
            {% endif %}
            {% endfor %}
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>

    <!-- Footer Legend -->
    <table class="footer-table">
        <tr>
            <td colspan="4" class="footer-heading">{{ current_timetable.footer_semester_text }}</td>
        </tr>
        <tr>
            <!-- Legends split into 2 massive columns for simplicity, or 4 to match image if possible -->
            <td class="footer-sub-heading" style="width: 25%;">SUBJECT NAME</td>
            <td class="footer-sub-heading" style="width: 25%;">FACULTY NAME</td>
            <td class="footer-sub-heading" style="width: 25%;">SUBJECT NAME</td>
            <td class="footer-sub-heading" style="width: 25%;">FACULTY NAME</td>
        </tr>
        <tr>
            <!-- We will list half subjects in col 1, half in col 3 etc if we can, or just duplicate for now -->
            <td class="footer-content">
                <ul class="legend">
                    {% for subject in subjects %}
                    <li><strong>{{ subject.name }}</strong> ({{ subject.code }})</li>
                    {% endfor %}
                </ul>
            </td>
            <td class="footer-content">
                <ul class="legend">
                    {% for faculty in faculties %}
                    <li>Prof. {{ faculty.user.get_full_name }} ({{ faculty.initials }})</li>
                    {% endfor %}
                </ul>
            </td>
            <td class="footer-content">
                <ul class="legend">
                    <!-- Placeholder or Continuation -->
                    <li>Introduction to Prob... (PS)</li>
                    <li>Digital Electronics (DE)</li>
                </ul>
            </td>
            <td class="footer-content">
                <ul class="legend">
                    <!-- Placeholder or Continuation -->
                    <li>Prof. Priyanka Sinha (PCS)</li>
                    <li>Prof. Mansi Hedav (MPH)</li>
                </ul>
            </td>
        </tr>
    </table>

    <!-- Signatures -->
    <table class="footer-table" style="border-top: none;">
        <tr>
            <td class="signature-section prepared-by">
                {{ current_timetable.footer_prepared_by|linebreaksbr }}
            </td>
            <td class="signature-section">
                {{ current_timetable.footer_hod|linebreaksbr }}
            </td>
        </tr>
    </table>

</div>

<script>
// Filter branch dropdown based on selected department
(function() {
    var deptSelect = document.getElementById('publish-department');
    var branchSelect = document.getElementById('publish-branch');
    if (!deptSelect || !branchSelect) return;

    // Store all branch options with their department IDs
    var allOptions = [];
    for (var i = 0; i < branchSelect.options.length; i++) {
        allOptions.push({
            value: branchSelect.options[i].value,
            text: branchSelect.options[i].text,
            el: branchSelect.options[i].cloneNode(true)
        });
    }

    // Build dept-to-branch mapping via data from the backend
    // We'll use a simple fetch approach
    function filterBranches() {
        var deptId = deptSelect.value;
        if (!deptId) {
            // Show all branches
            branchSelect.innerHTML = '';
            allOptions.forEach(function(opt) {
                branchSelect.appendChild(opt.el.cloneNode(true));
            });
            return;
        }
        // Fetch branches for selected department
        fetch('/generator/api/branches/?department=' + deptId)
            .then(function(r) { return r.json(); })
            .catch(function() { return null; })
            .then(function(data) {
                if (!data) return;
                branchSelect.innerHTML = '<option value="">---------</option>';
                data.forEach(function(b) {
                    var opt = document.createElement('option');
                    opt.value = b.id;
                    opt.text = b.name;
                    branchSelect.appendChild(opt);
                });
            });
    }

    deptSelect.addEventListener('change', filterBranches);
})();
</script>
{% endblock %}